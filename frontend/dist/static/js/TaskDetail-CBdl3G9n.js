import{d as ue,k as de,v as C,m as S,V as pe,p as _e,W as ve,c as d,b as a,w as s,y as me,X as fe,Y as ge,Z as ke,a as o,g as ye,E as be,e as N,t as n,z as he,f as r,q as h,A as we,i as y,h as w,$ as Ce,s as Se,a0 as Te,F as P,r as j,n as Ee,I as xe,J as Le,K as $e,u as De,o as c,R as ze,U as Re,_ as Ie}from"./index-BrQRFijk.js";/* empty css               *//* empty css                 *//* empty css                             *//* empty css                 *//* empty css                    *//* empty css               */import{g as Ue,b as T,a as We,h as Be,e as Me}from"./index-CqoqUkBq.js";/* empty css                   */const Ae={class:"task-detail"},Ve={class:"header-content"},Fe={class:"header-left"},Ne={class:"header-info"},Pe={class:"header-meta"},je={class:"task-id"},Oe={class:"header-right"},qe={key:0,class:"progress-content"},Ge={class:"progress-bar"},He={class:"progress-info"},Je={class:"current-step"},Ke={class:"value"},Xe={class:"progress-stats"},Ye={class:"log-header"},Ze={key:0,class:"empty-logs"},Qe={key:1,class:"log-list"},es={class:"log-time"},ss={class:"log-level"},ts={class:"log-message"},as={key:0,class:"task-info"},ls={key:0,class:"task-params"},os={key:1,class:"empty-params"},ns={class:"connection-status"},rs={class:"status-item"},cs={class:"status-actions"},is=ue({__name:"TaskDetail",setup(us){const O=pe();De();const E=de(),x=C(!1),m=C(!1),L=C(!0),_=C([]),$=C();let f=null;const b=S(()=>O.params.id),l=S(()=>E.currentTask),q=S(()=>{if(!l.value)return"加载中...";const t=l.value.parameters||{};return l.value.mode==="market"?`${t.author}/${t.name} v${t.version}`:l.value.mode==="github"?`${t.repo} ${t.release}`:l.value.mode==="local"?t.file_name||"本地文件":"未知任务"}),G=S(()=>l.value&&["pending","downloading","extracting","packaging"].includes(l.value.status)),H=S(()=>l.value&&l.value.status==="completed"),z=async()=>{x.value=!0;try{await E.fetchTask(b.value)}finally{x.value=!1}},J=async()=>{try{await ze.confirm("确定要取消这个任务吗？","确认取消",{type:"warning"}),await E.cancelTask(b.value),await z()}catch(t){t!=="cancel"&&console.error("取消任务失败:",t)}},K=()=>{const t=Re.downloadResult(b.value);Me(t)},X=t=>t&&{pending:"",downloading:"warning",extracting:"warning",packaging:"warning",completed:"success",failed:"danger",cancelled:"info"}[t]||"",Y=t=>{if(t==="completed")return"success";if(t==="failed")return"exception"},Z=t=>({market:"Marketplace",github:"Github",local:"本地文件"})[t]||t,Q=t=>({author:"作者",name:"名称",version:"版本",repo:"仓库",release:"发布版本",asset_name:"文件名",file_name:"文件名",platform:"平台",suffix:"后缀"})[t]||t,ee=t=>{Be(t)},I=()=>{f&&f.disconnect(),f=new ge(b.value,se,t=>{console.error("WebSocket错误:",t),m.value=!1},t=>{console.log("WebSocket关闭:",t),m.value=!1}),f.connect(),m.value=!0},U=()=>{f&&(f.disconnect(),f=null),m.value=!1},se=t=>{if(t.type==="progress"){const e=t.data;W("info",e.message||e.current_step),E.updateTaskProgress(e)}else t.type==="system"&&W("system",t.data.message)},W=(t,e)=>{_.value.push({timestamp:new Date().toISOString(),level:t,message:e}),L.value&&ke(()=>{$.value&&($.value.scrollTop=$.value.scrollHeight)}),_.value.length>1e3&&(_.value=_.value.slice(-500))},te=()=>{L.value=!L.value},ae=()=>{_.value=[]},le=()=>{const t=_.value.map(i=>`[${T(i.timestamp)}] ${i.level.toUpperCase()}: ${i.message}`).join(`
`),e=new Blob([t],{type:"text/plain"}),D=URL.createObjectURL(e),v=document.createElement("a");v.href=D,v.download=`task-${b.value}-logs.txt`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(D)};return _e(async()=>{await z(),l.value&&["pending","downloading","extracting","packaging"].includes(l.value.status)&&I()}),ve(()=>{U()}),(t,e)=>{const D=N("ArrowLeft"),v=be,i=ye,R=he,B=we,g=me,oe=Se,M=Te,A=Ce,ne=N("CopyDocument"),k=Le,V=xe,re=$e,ce=fe;return c(),d("div",Ae,[a(g,{class:"header-card"},{default:s(()=>{var u;return[o("div",Ve,[o("div",Fe,[a(i,{onClick:e[0]||(e[0]=p=>t.$router.go(-1)),circle:"",size:"small"},{default:s(()=>[a(v,null,{default:s(()=>[a(D)]),_:1})]),_:1}),o("div",Ne,[o("h3",null,n(q.value),1),o("div",Pe,[a(R,{type:X((u=l.value)==null?void 0:u.status)},{default:s(()=>{var p;return[r(n(h(Ue)((p=l.value)==null?void 0:p.status)),1)]}),_:1},8,["type"]),o("span",je,"ID: "+n(b.value),1)])])]),o("div",Oe,[a(B,null,{default:s(()=>[G.value?(c(),y(i,{key:0,type:"warning",onClick:J},{default:s(()=>e[2]||(e[2]=[r(" 取消任务 ")])),_:1,__:[2]})):w("",!0),H.value?(c(),y(i,{key:1,type:"success",onClick:K},{default:s(()=>e[3]||(e[3]=[r(" 下载结果 ")])),_:1,__:[3]})):w("",!0),a(i,{icon:x.value?"Loading":"Refresh",loading:x.value,onClick:z},{default:s(()=>e[4]||(e[4]=[r(" 刷新 ")])),_:1,__:[4]},8,["icon","loading"])]),_:1})])])]}),_:1}),a(ce,{gutter:24},{default:s(()=>[a(A,{span:16},{default:s(()=>[a(g,{class:"progress-card"},{header:s(()=>e[5]||(e[5]=[o("span",null,"任务进度",-1)])),default:s(()=>[l.value?(c(),d("div",qe,[o("div",Ge,[a(oe,{percentage:Math.round(l.value.progress*100),status:Y(l.value.status),"stroke-width":"12"},null,8,["percentage","status"])]),o("div",He,[o("div",Je,[e[6]||(e[6]=o("span",{class:"label"},"当前步骤:",-1)),o("span",Ke,n(l.value.current_step||"等待中..."),1)]),o("div",Xe,[o("span",null,n(Math.round(l.value.progress*100))+"% 完成",1),o("span",null,n(l.value.total_steps)+" 步骤",1)])])])):w("",!0)]),_:1}),a(g,{class:"log-card"},{header:s(()=>[o("div",Ye,[e[9]||(e[9]=o("span",null,"实时日志",-1)),a(B,null,{default:s(()=>[a(i,{size:"small",onClick:te},{default:s(()=>[r(n(L.value?"暂停滚动":"自动滚动"),1)]),_:1}),a(i,{size:"small",onClick:ae},{default:s(()=>e[7]||(e[7]=[r(" 清空日志 ")])),_:1,__:[7]}),a(i,{size:"small",onClick:le},{default:s(()=>e[8]||(e[8]=[r(" 导出日志 ")])),_:1,__:[8]})]),_:1})])]),default:s(()=>[o("div",{class:"log-content",ref_key:"logContainer",ref:$},[_.value.length===0?(c(),d("div",Ze,[a(M,{description:"暂无日志信息"})])):(c(),d("div",Qe,[(c(!0),d(P,null,j(_.value,(u,p)=>(c(),d("div",{key:p,class:Ee(["log-item",`log-${u.level}`])},[o("span",es,n(h(T)(u.timestamp)),1),o("span",ss,n(u.level.toUpperCase()),1),o("span",ts,n(u.message),1)],2))),128))]))],512)]),_:1})]),_:1}),a(A,{span:8},{default:s(()=>{var u;return[a(g,{class:"info-card"},{header:s(()=>e[10]||(e[10]=[o("span",null,"基本信息",-1)])),default:s(()=>[l.value?(c(),d("div",as,[a(V,{column:1,border:""},{default:s(()=>[a(k,{label:"任务ID"},{default:s(()=>[o("div",{class:"copyable-text",onClick:e[1]||(e[1]=p=>ee(l.value.task_id))},[r(n(l.value.task_id)+" ",1),a(v,{class:"copy-icon"},{default:s(()=>[a(ne)]),_:1})])]),_:1}),a(k,{label:"处理模式"},{default:s(()=>[a(R,null,{default:s(()=>[r(n(Z(l.value.mode)),1)]),_:1})]),_:1}),a(k,{label:"创建时间"},{default:s(()=>[r(n(h(T)(l.value.created_at)),1)]),_:1}),a(k,{label:"开始时间"},{default:s(()=>[r(n(h(T)(l.value.started_at)),1)]),_:1}),a(k,{label:"完成时间"},{default:s(()=>[r(n(h(T)(l.value.completed_at)),1)]),_:1}),l.value.file_size?(c(),y(k,{key:0,label:"文件大小"},{default:s(()=>[r(n(h(We)(l.value.file_size)),1)]),_:1})):w("",!0)]),_:1})])):w("",!0)]),_:1}),a(g,{class:"params-card"},{header:s(()=>e[11]||(e[11]=[o("span",null,"任务参数",-1)])),default:s(()=>{var p;return[(p=l.value)!=null&&p.parameters?(c(),d("div",ls,[a(V,{column:1,border:""},{default:s(()=>[(c(!0),d(P,null,j(l.value.parameters,(ie,F)=>(c(),y(k,{key:F,label:Q(F)},{default:s(()=>[r(n(ie),1)]),_:2},1032,["label"]))),128))]),_:1})])):(c(),d("div",os,[a(M,{description:"无参数信息"})]))]}),_:1}),(u=l.value)!=null&&u.error_message?(c(),y(g,{key:0,class:"error-card"},{header:s(()=>e[12]||(e[12]=[o("span",null,"错误信息",-1)])),default:s(()=>[a(re,{title:l.value.error_message,type:"error",closable:!1,"show-icon":""},null,8,["title"])]),_:1})):w("",!0),a(g,{class:"status-card"},{header:s(()=>e[13]||(e[13]=[o("span",null,"连接状态",-1)])),default:s(()=>[o("div",ns,[o("div",rs,[e[14]||(e[14]=o("span",{class:"status-label"},"WebSocket:",-1)),a(R,{type:m.value?"success":"danger"},{default:s(()=>[r(n(m.value?"已连接":"未连接"),1)]),_:1},8,["type"])]),o("div",cs,[m.value?(c(),y(i,{key:1,size:"small",type:"warning",onClick:U},{default:s(()=>e[16]||(e[16]=[r(" 断开连接 ")])),_:1,__:[16]})):(c(),y(i,{key:0,size:"small",type:"primary",onClick:I},{default:s(()=>e[15]||(e[15]=[r(" 连接实时日志 ")])),_:1,__:[15]}))])])]),_:1})]}),_:1})]),_:1})])}}}),bs=Ie(is,[["__scopeId","data-v-cc8b61cb"]]);export{bs as default};
